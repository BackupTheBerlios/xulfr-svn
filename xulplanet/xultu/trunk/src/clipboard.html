<p class="note">Attention, cette page est maintenue dans la version française, 
mais elle a été enlevée par son auteur sur la version anglaise.</p>

<p>
Cette section fournit des informations au sujet du couper, copier et coller dans le presse-papiers et à
partir du presse-papiers.
</p>

<h2>Le presse-papiers</h2>

<p>
Mozilla fournit un certain nombre d'interfaces pour accéder au presse-papiers. Le composant
<var>@mozilla.org/widget/clipboardhelper;1</var> peut être utilisé pour copier du texte dans le
presse-papiers. Ce composant implémente l'interface <code>nsIClipboardHelper</code>, dont la fonction
<code>copyString</code> peut être utilisée pour copier une chaîne de caractères.
</p>

<pre><code>const gClipboardHelper = Components.classes["@mozilla.org/widget/clipboardhelper;1"]
  .getService(Components.interfaces.nsIClipboardHelper);
gClipboardHelper.copyString("Mettez-moi dans le presse-papiers, s'il vous plaît.");
</code></pre>

<p>
Cet exemple va tout d'abord créer un outil d'aide pour le presse-papiers puis y copiera une courte
chaîne de caractère. Cette méthode fonctionne uniquement pour insérer des chaînes de caractères dans
le presse-papiers. Pour d'autres types de données, comme les URLs ou les images, vous aurez besoin
d'utiliser une méthode plus complexe.
</p>

<p>
Un composant <var>@mozilla.org/widget/clipboard;1</var> et une interface <code>nsIClipboard</code>
fournissent un accès
général au presse-papiers du système. Vous pouvez l'utiliser pour copier et coller n'importe quel
type de données de votre application vers le presse-papiers. Trois objets XPCOM sont nécessaires
pour manipuler les opérations concernant le presse-papiers. Le premier est un objet chargé de prendre les
données pour les insérer dans le presse-papiers. Le deuxième est l'objet presse-papiers. Le troisième
est un objet qui est utilisé pour transférer les données du premier objet vers le presse-papiers. Le
modèle de presse-papiers dans Mozilla nécessite que vous suiviez les étapes suivantes pour copier
les données&nbsp;:
</p>

<ol>
  <li>Créez un container XPCOM pour les données que vous souhaitez insérer dans le presse-papiers.
  C'est nécessaire parce que vous pouvez y mettre n'importe quoi, du texte jusqu'à des images,</li>
  <li>Créez un objet de transfert. Cet objet peut être le composant
  <var>@mozilla.org/widget/transferable;1</var> qui implémente l'interface <code>nsITransferable</code>,</li>
  <li>Spécifiez à l'objet de transfert le type de données à copier,</li>
  <li>Spécifiez à l'objet de transfert les données à copier,</li>
  <li>Créez un objet presse-papiers qui se réfère au presse-papiers du système,</li>
  <li>Spécifiez à l'objet presse-papiers de copier les données utilisant l'objet de transfert.</li>
</ol>

<p>
Vous pourriez vous demander pourquoi un objet de transfert est nécessaire au lieu de simplement
insérer directement l'objet dans le presse-papiers. L'une des raisons est que certains systèmes ne
copient pas les données tout de suite. Au lieu de cela, ils attendent jusqu'à ce que les données
soient collées. Une autre raison est que l'objet de transfert peut contenir de multiples représentations
d'une seule et même donnée. Par exemple, un extrait HTML peut être représenté autant dans sa
forme originale en HTML qu'en texte brut. Si une application souhaite obtenir la donnée à partir du
presse-papiers et ne comprend pas le HTML, elle peut utiliser la version en texte brut. Si elle
peut comprendre le HTML, elle peut récupérer cette version. L'objet de transfert contiendra le contenu
du presse-papiers jusqu'à ce que l'application ait précisé ses besoins. Il permet au
presse-papiers de pouvoir être utilisé par une autre application de suite.
</p>

<p>
Décomposons à présent les étapes nécessaires pour copier les données dans le presse-papiers. Tout
d'abord, nous avons besoin de créer un objet XPCOM pour encapsuler ce que nous voulons copier. Nous
supposerons que nous voulons copier un peu de texte. Nous utiliserons l'interface <code>nsISupportsString</code>
qui peut être utilisée pour représenter des chaînes de caractères (spécifiquement, des chaînes
en Unicode).
</p>

<pre><code>var copytext="Texte à copier";
var str = Components.classes["@mozilla.org/supports-string;1"]
   .createInstance(Components.interfaces.nsISupportsString);
str.data=copytext;
</code></pre>

<p>
La première ligne contient le texte que l'on veut copier. Ensuite, la variable <code>str</code> est
assignée à un composant qui peut être utilisé pour contenir une chaîne de caractères. La troisième
ligne assigne la chaîne de caractères au composant en utilisant la propriété <code>data</code>.
Ici, la chaîne de caractères <var>Texte à copier</var> va être copiée mais vous
pouvez la remplacer par la chaîne de caractères que vous souhaitez copier. À présent que l'on a
l'objet à copier, un objet de transfert doit être créé&nbsp;:
</p>

<pre><code>var trans = Components.classes["@mozilla.org/widget/transferable;1"]
      .createInstance(Components.interfaces.nsITransferable);
trans.addDataFlavor("text/unicode");
trans.setTransferData("text/unicode",str,copytext.length * 2);
</code></pre>

<p>
La première ligne reçoit le composant de transfert qui implémente <code>nsITransferable</code>.
Ensuite, nous devons spécifier à l'objet de transfert quel type de données nous souhaitons utiliser.
Le type de données est représenté par son type mime. La fonction <code>addDataFlavor</code>
est utilisée pour indiquer à l'objet de transfert qu'il doit transférer les données d'un
certain type.
Dans le cas présent, nous transférons le type mime <var>text/unicode</var> qui indique une
chaîne de caractères Unicode.
Puis, la fonction <code>setTransferData</code> qui copie les données de la chaîne
de caractères vers l'objet de transfert est appelée. Cette fonction prend en compte trois paramètres. Le
premier est le type mime que nous déclarons, le deuxième est l'objet qui contient la chaîne de
caractères et le troisième est la longueur de la donnée, en octets. Ici, la longueur est multipliée
par deux car nous utilisons une chaîne de caractères Unicode qui requiert deux octets par caractère.
</p>

<p>
Vous pouvez répéter les deux dernières lignes et appeler <code>addDataFlavor</code>
et <code>setTransferData</code> pour de multiples types mime. De cette façon, vous
pouvez avoir une version texte brut et une version HTML du contenu. L'objet de transfert va
contenir sa propre copie des données. Lorsque vous avez ajouté tous les types souhaités, 
vous pouvez tous les mettre dans le presse-papiers immédiatement. L'objet de transfert va
contenir toutes les données souhaitées jusqu'à ce que vous soyez prêt à les insérer dans le
presse-papiers.
</p>

<p>
Ensuite, nous devons créer un objet presse-papiers qui se réfère au presse-papiers du système.
</p>

<pre><code>var clipid = Components.interfaces.nsIClipboard;
var clip = Components.classes["@mozilla.org/widget/clipboard;1"].getService(clipid);
clip.setData(trans,null,clipid.kGlobalClipboard);
</code></pre>

<p>
Nous obtenons l'objet presse-papiers du système et le stockons dans la variable <code>clip</code>.
Nous pouvons copier la donnée dans le presse-papiers en appelant la fonction
<code>setData</code>. Le premier paramètre de cette fonction est l'objet de transfert.
Le deuxième paramètre est habituellement initialisé à <var>null</var> mais vous pourriez le
déclarer à un <code>nsIClipboardOwner</code> de sorte que vous puissiez indiquer
que la donnée copiée doit être écrasée lors d'une autre opération de copie.
N'appelez <code>setData</code> que
lorsque vous êtes prêt à copier dans le presse-papiers du système.
</p>

<p>
Le troisième paramètre de <code>setData</code> (ainsi que le paramètre de emptyClipboard) indique
quel tampon de presse-papiers utiliser. Le code ci-dessus utilise la constante
<code>kGlobalConstant</code> pour cela, qui se réfère au presse-papiers global. Ce serait la même
constante qui coupe et colle les opérations dans le menu d'édition utilisé généralement. Si vous utilisez
<code>kSelectionClipboard</code> à la place, vous allez copier dans le tampon de sélection,
qui n'est en général disponible que sous des systèmes Unix.
</p>

<p>
Ce processus pluri-étapes a eu pour résultat la copie du texte dans le presse-papiers. Nous pouvons
couper vers le presse-papiers au lieu de copier, en effaçant la donnée
originale après la copie. Normalement, le texte serait dans un document ou une zone de texte. Le code est rassemblé
ci-dessous, avec en plus une vérification des erreurs&nbsp;:
</p>

<pre><code>var copytext = "Texte à copier";

var str = Components.classes["@mozilla.org/supports-string;1"]
             .createInstance(Components.interfaces.nsISupportsString);
if (!str) return false;

str.data = copytext;

var trans = Components.classes["@mozilla.org/widget/transferable;1"]
          .createInstance(Components.interfaces.nsITransferable);
if (!trans) return false;

trans.addDataFlavor("text/unicode");
trans.setTransferData("text/unicode",str,copytext.length * 2);

var clipid = Components.interfaces.nsIClipboard;
var clip = Components.classes["@mozilla.org/widget/clipboard;1"].getService(clipid);
if (!clip) return false;

clip.setData(trans,null,clipid.kGlobalClipboard);
</code></pre>

<h2>Coller les contenus du presse-papiers</h2>

<p>
Pour coller la donnée à partir du presse-papiers nous pouvons utiliser un processus similaire, sauf
que nous employons <code>getData</code> au lieu de <code>setData</code> et <code>getTransferData</code>
au lieu de <code>setTransferData</code>. Voici les étapes pour le collage&nbsp;:
</p>

<ol>
  <li>Créez un objet presse-papiers qui se réfère au presse-papiers du système,</li>
  <li>Créez un objet de transfert qui implémente l'interface <code>nsITransferable</code>,</li>
  <li>Spécifiez à l'objet de transfert quel type de donnée vous souhaitez obtenir,</li>
  <li>Recherchez la donnée du presse-papiers et insérez-la dans l'objet de transfert,</li>
  <li>Récupérez la donnée à partir de l'objet de transfert.</li>
</ol>

<p>
La première étape est similaire à celle utilisée pour la copie&nbsp;:
</p>

<pre><code>
var clip = Components.classes["@mozilla.org/widget/clipboard;1"]
           .createInstance(Components.interfaces.nsIClipboard);
if (!clip) return false;

var trans = Components.classes["@mozilla.org/widget/transferable;1"]
          .createInstance(Components.interfaces.nsITransferable);
if (!trans) return false;
trans.addDataFlavor("text/unicode");
</code></pre>

<p>
Ce code reçoit l'objet presse-papiers du système et un objet de transfert. Le type mime est ajouté
à ce dernier. Maintenant, nous avons besoin d'obtenir la donnée du presse-papiers&nbsp;:
</p>

<pre><code>
clip.getData(trans,clip.kGlobalClipboard);

var str = new Object();
var strLength = new Object();

trans.getTransferData("text/unicode",str,strLength);
</code></pre>

<p>
La première ligne exécute le contraire de <code>setData</code>. La donnée actuellement
dans le presse-papiers du système est placée dans l'objet de transfert. Ensuite, nous créons deux objets
Javascript qui prendrons la donnée et sa longueur. Notez que nous n'avons aucune idée du type de
donnée qui est actuellement dans le presse-papiers. Elle a pu avoir été placée là par une autre
application. C'est pour cela que nous utilisons des objets génériques pour <code>str</code> et
<code>strLength</code>.
</p>

<p>
Puis nous utilisons <code>getTransferData</code> pour récupérer la donnée à partir
de l'objet de transfert. Nous spécifions le type mime que nous voudrions obtenir.
La donnée sera convertie si elle n'est pas du type désiré et si une conversion entre le type mime
actuel et celui voulu est possible. Si vous avez copié la donnée sous plusieurs
types dans le presse-papiers, vous pouvez récupérer la donnée dans le meilleur format voulu.
Par exemple, un champ de saisie de texte accepterait du texte unicode (ou du texte brut) tandis qu'une
fenêtre d'édition pourrait accepter du HTML et des images.
</p>

<p>
La variable <code>str</code> contient maintenant la donnée du presse-papiers. Nous
devons à nouveau convertir la donnée dans une chaîne de caractères Javascript à partir d'un objet
XPCOM. Pour ce faire, le code ci-dessous peut être utilisé&nbsp;:
</p>

<pre><code>if (str) str = str.value.QueryInterface(Components.interfaces.nsISupportsString);
if (str) pastetext = str.data.substring(0,strLength.value / 2);
</code></pre>

<p>
Du fait que la donnée de l'objet de transfert est un <code>nsISupportsString</code>,
nous devons la convertir en une chaîne de caractères Javascript. La propriété
<code>value</code> de l'objet complété par <code>getTransferData</code>, qui est
<var>str</var> dans ce cas, fournit la valeur actuelle de l'objet.
</p>

<p>
Nous assignons la chaîne de caractères à la variable <code>pastetext</code>. Nous
pouvons ainsi la mettre dans un champ texte ou à un autre endroit si nécessaire.
</p>

<hr />

<p>
Dans la prochaine section, nous verrons comment faire du glisser-déposer.
</p>

