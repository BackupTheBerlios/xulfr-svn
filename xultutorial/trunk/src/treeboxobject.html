
<p>Cette section va décrire l'objet de boîte d'arbre qui est utilisé pour gérer l'affichage d'un arbre.</p>

<h2>À propos de l'objet de boîte</h2>

<p>Les objets de boîte ont été décrits dans une section précédente. L'objet de boîte d'arbre est 
un objet de boîte spécial utilisé spécifiquement pour les arbres. La boîte d'arbre implémente l'interface 
<code>TreeBoxObject</code>.</p>

<p>Nous avons déjà vu la fonction <code>rowCountChanged</code> de l'objet de boîte d'arbre dans 
la section précédente. Elle est employée pour indiquer qu'une ou plusieurs lignes de l'arbre ont 
été ajoutées ou enlevées. L'arbre rafraîchira l'affichage de la zone affectée. Vous n'avez pas 
besoin d'appeler la fonction <code>rowCountChanged</code> lorsqu'une ligne a simplement été 
modifiée, comme par exemple lors du changement du libellé d'une cellule. Dans ce cas, d'autres 
fonctions d'affichage peuvent être utilisées. La plus simple est la fonction <code>invalidateRow</code> 
qui rafraîchit l'affichage d'une ligne spécifique d'un arbre. L'arbre appellera la vue pour obtenir 
les données mises à jour et actualise son contenu à l'écran.</p>

<p>Les autres fonctions de redessinage sont <code>invalidateCell</code> pour l'actualisation d'une 
unique cellule, <code>invalidateColumn</code> pour l'actualisation d'une colonne, <code>invalidateRange</code> 
pour l'actualisation d'une plage de lignes, ou la fonction <code>invalidate</code> pour l'actualisation 
de l'arbre entier. Notez que l'actualisation de l'affichage n'aura pas lieu avant que les scripts aient 
terminé car Mozilla n'effectue pas le redessinage en tâche de fond.</p>

<p>Vous pouvez également faire défiler l'arbre en utilisant quatre différentes méthodes similaires à 
celles disponibles pour les menus déroulants. La fonction <code>scrollToRow</code> peut être utilisée 
pour faire le défilement jusqu'à une ligne particulière. Voici un simple exemple&nbsp;:</p>

<p>Exemple 8.6.1&nbsp;:
<a href="exemples/ex_treeboxobject_1.xul.txt">Source</a>
<a href="exemples/ex_treeboxobject_1.xul" onclick="window.open(this.href,'xulex','chrome,resizable'); return false;">Voir</a></p>

<pre><code>&lt;script&gt;
function doScroll()
{
  var value = document.getElementById("tbox").value;
  var tree = document.getElementById("thetree");

  var boxobject = tree.boxObject;
  boxobject.QueryInterface(Components.interfaces.nsITreeBoxObject);
  boxobject.scrollToRow(value);
}
&lt;/script&gt;

&lt;tree id="thetree" rows="4"&gt;
  &lt;treecols&gt;
    &lt;treecol id="row" label="Ligne" primary="true" flex="1"/&gt;
  &lt;/treecols&gt;
  &lt;treechildren&gt;
    &lt;treeitem label="Ligne 0"/&gt;
    &lt;treeitem label="Ligne 1"/&gt;
    &lt;treeitem label="Ligne 2"/&gt;
    &lt;treeitem label="Ligne 3"/&gt;
    &lt;treeitem label="Ligne 4"/&gt;
    &lt;treeitem label="Ligne 5"/&gt;
    &lt;treeitem label="Ligne 6"/&gt;
    &lt;treeitem label="Ligne 7"/&gt;
    &lt;treeitem label="Ligne 8"/&gt;
    &lt;treeitem label="Ligne 9"/&gt;
  &lt;/treechildren&gt;
&lt;/tree&gt;

&lt;hbox align="center"&gt;
  &lt;label value="Défile jusqu'à la ligne :"/&gt;
  &lt;textbox id="tbox"/&gt;
  &lt;button label="Défile" oncommand="doScroll();"/&gt;
&lt;/hbox&gt;</code></pre>

<p class="note">Notez que nous utilisons l'attribut <code class="attribut">rows</code> sur 
l'élément <code class="tag"><a href="http://xulfr.org/wiki/Reference/Xul/tree">tree</a></code> 
pour définir que seulement quatre lignes sont affichées à la fois. Ainsi, il est plus facile 
de se représenter l'exemple. Notez également que la première ligne commence à <var>0</var>.</p>

<p>La fonction <code>doScroll</code> récupère l'objet de boîte et appelle la fonction <code>scrollToRow</code> 
avec comme argument la valeur saisie dans le champ texte. Vous noterez que l'objet de boîte 
d'arbre peut être obtenu de la même manière qu'avec d'autres objets de boîte, en utilisant la 
propriété <code>boxObject</code>, mais nous devons toutefois appeler <code>QueryInterface</code> 
pour invoquer l'objet de boîte très spécifique qu'est l'arbre. Les fonctions les plus générales 
de l'objet de boîte sont également disponibles pour les arbres.</p>

<p>Les méthodes supplémentaires de défilement incluent les fonctions <code>scrollByLines</code>, 
<code>scrollByPages</code>, et <code>ensureRowIsVisible</code>. la fonction <code>scrollByLines</code> 
fait défiler vers le haut ou vers le bas d'un certain nombre de lignes&nbsp;; un nombre positif 
fait défiler vers le bas, et un nombre négatif fait défiler vers le haut. La fonction 
<code>scrollByPages</code> fait défiler d'un nombre de pages. Elle est appelée automatiquement 
lorsque l'utilisateur appuie sur une touche <kbd>Page Up</kbd> ou <kbd>Page Down</kbd> avec un 
arbre qui a le focus. Une page est égale au nombre de lignes visibles. Par exemple, si un arbre 
affiche 10 lignes en même temps, une page sera équivalente à 10 lignes. C'est une méthode pratique 
dès lors que l'utilisateur redimensionne un arbre flexible, la taille de la page augmentera ou 
diminuera automatiquement sans avoir à la recalculer manuellement. Il n'est pas trop difficile 
de calculer cette taille manuellement car l'objet de boîte d'arbre fournit également une fonction 
<code>getPageLength</code> qui retourne le nombre de lignes dans une page. Dans l'exemple de 
défilement ci-dessus, <code>getPageLength</code> retournerait <var>4</var>.</p>

<p class="note">Notez que dans Firefox 1.0 et Mozilla 1.7 et les versions plus récentes, la 
fonction <code>getPageLength</code> est plutôt appelée <code>getPageCount</code>. Le nom a été 
changée en <code>getPageLength</code> afin d'éviter les confusions avec une fonction qui ne 
retourne pas le nombre de pages d'un arbre, mais la taille de chaque page. Vous pouvez déterminer 
le nombre de pages en divisant le nombre total de lignes par la taille d'une page.</p>

<p>La fonction <code>ensureRowIsVisible</code> fera défiler l'arbre jusqu'à une ligne comme avec 
la fonction <code>scrollToRow</code> seulement si la ligne n'est actuellement pas visible.</p>

<h2>Coordonnées d'une cellule</h2>

<p>Certaines des fonctions les plus intéressantes d'un objet de boîte d'arbre sont utilisées pour 
obtenir les parties d'un arbre à des coordonnées spécifiques. La fonction <code>getCellAt</code> 
peut être utilisée pour obtenir une cellule précise située à un emplacement défini en pixels, 
tandis que la fonction <code>getRowAt</code> peut être utilisée pour obtenir une ligne à un 
emplacement spécifique. La fonction <code>getRowAt</code> prend deux arguments qui sont les coordonnées x et y.</p>

<pre><code>tree.boxObject.getRowAt( 50, 100 );</code></pre>

<p>Cet exemple retournera l'index de la ligne ayant une position horizontale de <var>50</var> 
et verticale de <var>100</var>. Naturellement, la coordonnée x semble ne pas avoir beaucoup de 
sens dès lors que la ligne occupe tout l'espace horizontal de l'arbre. Une chose importante est 
de noter que les coordonnées sont mesurées à partir du coin en haut et à gauche du document et 
non de l'arbre lui même. Il est donc facile de passer à ces fonctions les coordonnées événementielles 
de l'objet <code>event</code>, comme avec la fonction <code>getCellAt</code> dans l'exemple suivant.</p>

<p>Exemple 8.6.2&nbsp;:
<a href="exemples/ex_treeboxobject_2.xul.txt">Source</a>
<a href="exemples/ex_treeboxobject_2.xul" onclick="window.open(this.href,'xulex','chrome,resizable'); return false;">Voir</a></p>

<pre><code>
&lt;script&gt;
function updateFields(event)
{
  var row = {}, column = {}, part = {};
  var tree = document.getElementById("thetree");

  var boxobject = tree.boxObject;
  boxobject.QueryInterface(Components.interfaces.nsITreeBoxObject);
  boxobject.getCellAt(event.clientX, event.clientY, row, column, part);

  if (typeof column.value != "string") column.value = column.id;

  document.getElementById("row").value = row.value;
  document.getElementById("column").value = column.value;
  document.getElementById("part").value = part.value;
}
&lt;/script&gt;

&lt;tree id="thetree" flex="1" onmousemove="updateFields(event);"&gt;
  &lt;treecols&gt;
    &lt;treecol id="ustensile" label="Ustensiles" primary="true" flex="1"/&gt;
    &lt;treecol id="nombre" label="Nombre" flex="1"/&gt;
  &lt;/treecols&gt;
  &lt;treechildren&gt;
    &lt;treeitem&gt;
      &lt;treerow&gt;
        &lt;treecell label="Fourchette"/&gt;
        &lt;treecell label="5"/&gt;
      &lt;/treerow&gt;
    &lt;/treeitem&gt;
    &lt;treeitem&gt;
      &lt;treerow&gt;
        &lt;treecell label="Couteau"/&gt;
        &lt;treecell label="2"/&gt;
      &lt;/treerow&gt;
    &lt;/treeitem&gt;
    &lt;treeitem&gt;
      &lt;treerow&gt;
        &lt;treecell label="Cuillère"/&gt;
        &lt;treecell label="8"/&gt;
      &lt;/treerow&gt;
    &lt;/treeitem&gt;
  &lt;/treechildren&gt;
&lt;/tree&gt;

&lt;label value="Ligne:"/&gt;
&lt;label id="row"/&gt;
&lt;label value="Colonne:"/&gt;
&lt;label id="column"/&gt;
&lt;label value="Type enfant:"/&gt;
&lt;label id="part"/&gt;
</code></pre>

<p>La fonction <code>getCellAt</code> prend cinq arguments, les coordonnées où regarder 
et trois autres paramètres. Un argument par référence est utilisé parce que la fonction a 
besoin de retourner plus d'une valeur. Vous verrez de nombreuses interfaces utilisant des 
arguments par référence avec 
<a href="http://www.xulplanet.com/references/objref/" title="Site de xulplanet (en)">les objets disponibles</a>. 
Ces arguments sont marqués avec un préfixe 'out'. Pour ceux-ci, vous devez transmettre un 
objet vide et la fonction remplira sa propriété <code class="attribut">value</code> avec 
la valeur nécessaire.</p>

<p>Les trois paramètres par référence seront renseignés avec la ligne, la colonne et le 
type enfant. L'objet row contient l'index de la ligne survolée par la souris au moment 
où la fonction a été appelée par un évènement mousemove avec les coordonnées de cet évènement. 
Si les coordonnées ne sont pas au dessus d'une ligne de l'arbre, la valeur <code>row.value</code> 
sera égale à <var>-1</var>. La variable column est un objet <code>column</code> tel que 
défini dans Mozilla 1.8 et supérieur. <!-- Alain B: Bizarre, la version actuelle de Mozilla n'est que la 1.7.x --> 
Dans les versions plus anciennes, les colonnes étaient identifiées avec un chaîne de 
caractères, l'identifiant <code class="attribut">id</code> de la colonne. Avec les versions 
plus récentes, un objet séparé de colonne existe et permet de réaliser des requêtes sur les données en colonne.</p>

<p>La ligne suivante est utilisée pour que l'exemple ci-dessus puisse fonctionner avec toutes les versions.</p>

<pre><code>if (typeof column.value != "string") column.value = column.id;</code></pre>

<p>Si la colonne est une chaîne de caractères, nous tournons sur Mozilla 1.7 ou inférieur, 
mais pour les versions récentes, nous obtenons l'identifiant de la colonne à partir de l'objet 
column. Si vous écrivez du code pour des versions multiples, vous devrez effectuer un test comme indiqué ci-avant.</p>

<p>Le dernier argument de la fonction <code>getCellAt</code> est le type enfant renseigné 
avec une chaîne dépendante de la partie de la cellule pointée par les coordonnées. Si vous 
déplacez la souris dans l'exemple précédent, vous noterez que le libellé passe de <var>text</var> 
à <var>cell</var>. La valeur <var>text</var> indique la zone où le texte est dessiné et la 
valeur <var>cell</var> indique la zone autour du texte, par exemple, la marge de gauche où 
sont habituellement dessinées les poignées ouvrantes et fermantes. Toutefois, s'il y avait 
une poignée, la valeur aurait plutôt été <var>twisty</var>. Cette information est pratique 
pour vous permettre de déterminer si l'utilisateur a cliqué sur une poignée plutôt que sur 
une autre partie de la ligne. En fait, lorsque l'utilisateur double-clique sur la poignée, 
le code natif sous-jacent utilise cette méthode. La dernière valeur qui peut être retournée 
est <var>image</var> si une image se trouve dans la cellule et que les coordonnées correspondent 
à celle de l'image. Bien entendu, dans la plupart des cas, vous ne désirez pas connaître 
quelle partie de la cellule pointe les coordonnées, mais seulement la ligne et la colonne concernées.</p>

<p>Pour inverser la recherche et obtenir les coordonnées spécifiques à une cellule, utilisez la 
fonction <code>getCoordsForCellItem</code>. Elle prend sept arguments tels que décrit ci-dessous.</p>

<pre><code>
var x = {}, y = {}, width = {}, height = {};
tree.boxObject.getCoordsForCellItem( row, column, part, x, y, width, height );
</code></pre>

<p>Les arguments 'row', 'column' et 'part' sont similaires à ceux retournés par la fonction 
<code>getCellAt</code>. De nouveau, l'argument column doit soit être une chaîne de caractères, 
ou soit être un objet column, selon la version que vous utilisez. Le type de la zone de la cellule 
peut être utilisé pour obtenir les coordonnées, soit du texte, soit de toute la cellule, soit de la 
poignée ou soit de l'image dans la cellule. Les mêmes valeurs que la fonction <code>getCellAt</code> 
sont utilisées. La fonction <code>getCoordsForCellItem</code> retourne, au travers des arguments 
passés en référence, les coordonnées x et y accompagnées de la largeur et la hauteur.</p>

<hr />

<p>Par la suite, nous verrons comment RDF peut être utilisé automatiquement pour peupler des 
arbres et d'autres éléments.</p>
